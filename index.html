<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Title</title>
  </head>
  <body>
    <div style="height:650px">
      <div id="screens-1" style="float:left;">INTERACTIVE mouse data<br></div>
      <div id="screens-2" style="float:left;">NON-INTERACTIVE mouse data<br></div>
    </div>
    BACKGROUND:
    <select name="screen" id="select" onchange="setHeatmap()">
    </select>
    &nbsp;&nbsp;
    CUSTOM:
    <input type="text" id="myBackground" name="myBackground"><button onclick="setHeatmap()">SET</button>
    &nbsp;&nbsp;
    <input type="checkbox" id="check" name="background" checked onchange="setHeatmap()"/><label for="check">Include background</label>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    <input type="radio" id="type-heatmap" name="type" value="type-heatmap" checked onclick="setHeatmap()"><label for="type-heatmap">Heatmap</label>
    <input type="radio" id="type-clickmap" name="type" value="type-clickmap" onclick="setHeatmap()"><label for="type-clickmap">Clickmap</label>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    <input type="checkbox" id="first" name="first" onchange="setHeatmap()" checked/><label for="first">First-clicks</label>
    <input type="checkbox" id="second" name="second" onchange="setHeatmap()" checked/><label for="second">None-first-clicks</label>
    <input type="checkbox" id="last" name="last" onchange="setHeatmap()"/><label for="last">Last-clicks</label>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    <input type="checkbox" id="t1" name="task" onchange="setHeatmap()" checked/><label for="t1">Task1</label>
    <input type="checkbox" id="t2" name="task" onchange="setHeatmap()" checked/><label for="t2">Task2</label>
    <input type="checkbox" id="t3" name="task" onchange="setHeatmap()" checked/><label for="t3">Task3</label>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    <button onclick="downloadHeatmap()">Download</button>
    <div id="heatmapContainer" style="position: relative;">
      <canvas id="clickmap"></canvas>
    </div>
    <div><canvas id="export" style="display: none;"></canvas></div>
    <script src="heatmap.js"></script>
    <script src="data.js"></script>
    <script>
      let heatmap;

      window.onload = () => {
        let backgroundSelect = document.querySelector('#select');
        let screens1Div = document.querySelector('#screens-1');
        let screens2Div = document.querySelector('#screens-2');
        
        for (const [key, value] of Object.entries(DATA_INTERACTIVE)) {
          let option = document.createElement('option');
          option.value = key;
          option.innerText = key;

          let input = document.createElement('input');
          input.type="checkbox";
          input.name="screen";
          input.id=key+'-i';
          input.onchange = () => setHeatmap();

          let label = document.createElement('label');
          label.innerHTML = key;
          label.htmlFor=key+'-i';
          
          screens1Div.appendChild(input);
          screens1Div.appendChild(label);
          screens1Div.appendChild(document.createElement('br'));
          backgroundSelect.appendChild(option);
        }

        backgroundSelect.selectedIndex = Array.from(backgroundSelect).map(x=>x.value).findIndex(x=>x=='HOME');

        for (const [key, value] of Object.entries(DATA_NON_INTERACTIVE)) {
          let input = document.createElement('input');
          input.type="checkbox";
          input.name="screen";
          input.id=key+'-n';
          input.onchange = () => setHeatmap();

          let label = document.createElement('label');
          label.innerHTML = key;
          label.htmlFor=key+'-n';
          
          screens2Div.appendChild(input);
          screens2Div.appendChild(label);
          screens2Div.appendChild(document.createElement('br'));
        }
      }

      function setHeatmap() {

        let backgroundSelect = document.querySelector('#select');
        let backgroundCheck = document.querySelector('#check').checked;
        let screenCheckboxes = Array.from(document.querySelectorAll('input[name="screen"]:checked')).map(x=>x.id);
        let first = document.querySelector('#first').checked;
        let second = document.querySelector('#second').checked;
        let last = document.querySelector('#last').checked;
        let tasks = Array.from(document.querySelectorAll('input[name="task"]:checked')).map(x=>x.id);

        let background = select.options[select.selectedIndex].value;
        let myBackground = document.querySelector('#myBackground').value;
        if(myBackground && myBackground != ""){
          background = myBackground
        }

        let type = document.querySelector('input[name="type"]:checked').value;

        setHeatmapContent(background, backgroundCheck, screenCheckboxes, first, second, last, tasks, type);
      }

      function getHeatmapData(screens, first, second, last, tasks) {
        let data1;
        let data2;

        let screens1 = []
        screens.filter(x=>x.endsWith('-i')).forEach(x=>{screens1.push(x.split('-i')[0])})
        let screens2 = []
        screens.filter(x=>x.endsWith('-n')).forEach(x=>{screens2.push(x.split('-n')[0])})

        data1 = Object.fromEntries(Object.entries(DATA_INTERACTIVE).filter(([k,v]) => screens1.includes(k)));
        data2 = Object.fromEntries(Object.entries(DATA_NON_INTERACTIVE).filter(([k,v]) => screens2.includes(k)));

        let dataPoints = [];

        for (const [key, value] of Object.entries(data1)) {
            dataPoints = dataPoints.concat(value.points)
        }
        for (const [key, value] of Object.entries(data2)) {
            dataPoints = dataPoints.concat(value.points)
        }

        let mapped = tasks.map(x=>Number(x[1]))

        dataPoints = dataPoints.filter(x=>{
          return mapped.includes(x['task'])
        })

        if((first && !second && last)){
          dataPoints = dataPoints.filter(x=>{
            return x['firstClick']==1 || x['lastClick']==1
          })
        }
        if((first && !second && !last)){
          dataPoints = dataPoints.filter(x=>{
            return x['firstClick']==1
          })
        }
        if((!first && second)){
          dataPoints = dataPoints.filter(x=>{
            return x['firstClick']==0
          })
        }
        if((!first && !second && last)){
          dataPoints = dataPoints.filter(x=>{
            return x['lastClick']==1
          })
        }
        if((!first && !second && !last)){
          dataPoints = dataPoints.filter(x=>{
            return false
          })
        }
        console.log(dataPoints)
        return dataPoints
      }

      function printHeatmap(dataPoints, maxWidth, maxHeight, container) {

        let clickCanvas = document.querySelector('#clickmap');
        let clickCtx = clickCanvas.getContext('2d');
        clickCtx.clearRect(0, 0, clickCanvas.width, clickCanvas.height);

        if(heatmap){
          heatmap.repaint()
        }
         else {
            heatmap = h337.create({
              container: container,
              radius: 35,
              maxOpacity: .5
            });
        }

        let canvas = document.querySelector('canvas.heatmap-canvas');
        canvas.width  = maxWidth;
        canvas.height = maxHeight;

        let tmp = {}
        let max = 0;

        dataPoints.forEach(p => {
           p.x=Math.round(p.x)
           p.y=Math.round(p.y)
           let str = `${Number(p['x']).toFixed(0)}-${Number(p['y']).toFixed(0)}`;
           if (!tmp.hasOwnProperty(str)) {
             tmp[str] = 0;
           }
           tmp[str]++;
           if (tmp[str] > max) max = tmp[str];
        });

        if(dataPoints.length>0){
          heatmap.setData({
            max: max,
            data: dataPoints
          })
        }
        else{
          heatmap.setData({data:[]})
        }
      }

      function printClickMap(dataPoints, maxWidth, maxHeight, container) {
        if(heatmap) heatmap.setData({data:[]})
        let canvas = document.querySelector('#clickmap');
        canvas.width = maxWidth;
        canvas.height = maxHeight;
        let ctx = canvas.getContext('2d');
        ctx.font = "10px serif";
        
        dataPoints.forEach(point => {
          ctx.beginPath();
          ctx.arc(point.x, point.y, 8, 0, 2 * Math.PI);
          ctx.fillStyle = "yellow";
          ctx.fill();
          ctx.stroke();
        })
      }

      function setHeatmapContent(background, backgroundCheck, screens, first, second, last, tasks, type) {
        let container = document.querySelector('#heatmapContainer');
        let maxHeight = DATA_INTERACTIVE[background]['height'];
        let maxWidth = DATA_INTERACTIVE[background]['width'];
        container.style.height = String(maxHeight) + 'px';
        container.style.width = String(maxWidth) + 'px';

        if(backgroundCheck) {
          try {
            container.style.backgroundImage = 'url(img/' + background + ".png" + ')';
          } catch {}
        }
        else {
          container.style.backgroundImage = 'none';
        }

        dataPoints = getHeatmapData(screens, first, second, last, tasks);
        if(type=="type-heatmap") {
          printHeatmap(dataPoints, maxWidth, maxHeight, container)
        }
        else if(type=="type-clickmap"){
          printClickMap(dataPoints, maxWidth, maxHeight, container)
        }
      }

      function downloadHeatmap() {
        let backgroundCheck = document.querySelector('#check').checked;
        let background = document.querySelector('#select').options[select.selectedIndex].value;
        let myBackground = document.querySelector('#myBackground').value;
        if(myBackground && myBackground != ""){
          background = myBackground
        }
        let maxHeight = DATA_INTERACTIVE[background]['height'];
        let maxWidth = DATA_INTERACTIVE[background]['width'];
        let type = document.querySelector('input[name="type"]:checked').value;
        
        let canvas = document.querySelector('canvas#export');
        canvas.style.display = 'block';
        let context = canvas.getContext('2d');

        canvas.width = maxWidth;
        canvas.height = maxHeight;

        if(backgroundCheck) {
          base_image = new Image();
          try{
            base_image.src = 'img/' + background + ".png";
          } catch{}
          
          base_image.onload = function() {
            context.drawImage(base_image, 0, 0);
            if(type=="type-heatmap"){
              context.drawImage(document.querySelector("canvas.heatmap-canvas"),0,0)
            }
            else if(type=="type-clickmap"){
              context.drawImage(document.querySelector("canvas#clickmap"),0,0)
            }
            
            let id = "downloadLink";
            let link = document.querySelector('#' + id);
            if(link == null) {
              link = document.createElement('a');
              link.id = id;
            }
            link.download = 'heatmap.png';
            link.href = canvas.toDataURL()
            link.click();
            canvas.style.display = 'none';
          }
        }
        else{
          context.drawImage(document.querySelector("canvas.heatmap-canvas"),0,0);
          if(type=="type-heatmap"){
            context.drawImage(document.querySelector("canvas.heatmap-canvas"),0,0)
          }
          else if(type=="type-clickmap"){
            context.drawImage(document.querySelector("canvas#clickmap"),0,0)
          }
          
          let id = "downloadLink";
          let link = document.querySelector('#' + id);
          if(link == null) {
            link = document.createElement('a');
            link.id = id;
          }
          link.download = 'heatmap.png';
          link.href = canvas.toDataURL()
          link.click();
          canvas.style.display = 'none';
        }
      }
    </script>
  </body>
</html>